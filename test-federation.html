<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Module Federation æµ‹è¯•</title>
    <script type="importmap">
      {
        "imports": {
          "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
        }
      }
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #5e72e4;
        padding-bottom: 10px;
      }
      .test-section {
        margin: 30px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 4px;
      }
      .test-section h2 {
        color: #5e72e4;
        margin-top: 0;
      }
      #result {
        padding: 15px;
        background: #e9ecef;
        border-left: 4px solid #5e72e4;
        margin-top: 15px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 14px;
      }
      .success {
        color: #28a745;
      }
      .error {
        color: #dc3545;
      }
      .info {
        color: #17a2b8;
      }
      button {
        padding: 10px 20px;
        background: #5e72e4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #4c63d2;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸš€ Module Federation é›†æˆæµ‹è¯•</h1>

      <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯• Robot Admin çš„æ¨¡å—è”é‚¦é…ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        <ul>
          <li
            ><strong>Remote Entry URL:</strong>
            http://localhost:4173/assets/remoteEntry.js</li
          >
          <li><strong>æš´éœ²çš„ç»„ä»¶:</strong> Table, Form, Tree, Icon, Editor</li>
        </ul>
      </div>

      <div class="test-section">
        <h2>ğŸ” æµ‹è¯•æ­¥éª¤</h2>
        <button onclick="runTest()">å¼€å§‹æµ‹è¯•</button>
        <div id="result"></div>
      </div>

      <div class="test-section">
        <h2>ğŸ’¡ é¢„æœŸç»“æœ</h2>
        <ul>
          <li>âœ… remoteEntry.js å¯ä»¥æˆåŠŸåŠ è½½</li>
          <li>âœ… èƒ½å¤Ÿè®¿é—® __FEDERATION__.robotAdmin</li>
          <li>âœ… èƒ½å¤Ÿè·å–åˆ° 5 ä¸ªæš´éœ²çš„ç»„ä»¶</li>
        </ul>
      </div>
    </div>

    <script type="module">
      window.runTest = async function () {
        const resultDiv = document.getElementById('result')
        let log = ''

        function addLog(message, type = 'info') {
          const timestamp = new Date().toLocaleTimeString()
          log += `[${timestamp}] <span class="${type}">${message}</span>\n`
          resultDiv.innerHTML = log
        }

        try {
          addLog('ğŸš€ å¼€å§‹æµ‹è¯• Module Federation...', 'info')

          // æµ‹è¯• 1: æ£€æŸ¥ remoteEntry.js æ˜¯å¦å­˜åœ¨
          addLog('\nğŸ“¥ æµ‹è¯• 1: æ£€æŸ¥ remoteEntry.js è®¿é—®æ€§...', 'info')
          const remoteUrl = 'http://localhost:4173/assets/remoteEntry.js'

          try {
            const response = await fetch(remoteUrl, { method: 'HEAD' })
            if (response.ok) {
              addLog('âœ… remoteEntry.js å¯ä»¥è®¿é—®', 'success')
              addLog(`   Status: ${response.status}`, 'info')
              addLog(
                `   Content-Type: ${response.headers.get('content-type')}`,
                'info'
              )
            } else {
              addLog(`âŒ remoteEntry.js è®¿é—®å¤±è´¥: ${response.status}`, 'error')
              return
            }
          } catch (error) {
            addLog(`âŒ æ— æ³•è¿æ¥åˆ° remoteEntry.js: ${error.message}`, 'error')
            addLog(
              '   è¯·ç¡®è®¤ Robot Admin é¢„è§ˆæœåŠ¡å·²å¯åŠ¨åœ¨ http://localhost:4173',
              'error'
            )
            return
          }

          // æµ‹è¯• 2: åŠ¨æ€åŠ è½½ remoteEntry.js
          addLog('\nğŸ“¦ æµ‹è¯• 2: åŠ¨æ€åŠ è½½ remoteEntry.js...', 'info')

          const script = document.createElement('script')
          script.src = remoteUrl
          script.type = 'module'

          await new Promise((resolve, reject) => {
            script.onload = () => {
              addLog('âœ… remoteEntry.js åŠ è½½æˆåŠŸ', 'success')
              resolve()
            }
            script.onerror = error => {
              addLog(`âŒ remoteEntry.js åŠ è½½å¤±è´¥: ${error}`, 'error')
              reject(error)
            }
            document.head.appendChild(script)
          })

          // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿åˆå§‹åŒ–å®Œæˆ
          await new Promise(resolve => setTimeout(resolve, 500))

          // æµ‹è¯• 3: æ£€æŸ¥ __FEDERATION__ å¯¹è±¡
          addLog('\nğŸ” æµ‹è¯• 3: æ£€æŸ¥ __FEDERATION__ å¯¹è±¡...', 'info')

          if (typeof window.__FEDERATION__ !== 'undefined') {
            addLog('âœ… __FEDERATION__ å¯¹è±¡å­˜åœ¨', 'success')
            addLog(
              `   Keys: ${Object.keys(window.__FEDERATION__).join(', ')}`,
              'info'
            )

            if (window.__FEDERATION__.robotAdmin) {
              addLog('âœ… robotAdmin è¿œç¨‹æ¨¡å—å·²æ³¨å†Œ', 'success')

              // æµ‹è¯• 4: è·å–æš´éœ²çš„ç»„ä»¶
              addLog('\nğŸ“¦ æµ‹è¯• 4: è·å–æš´éœ²çš„ç»„ä»¶...', 'info')

              const exposedModules = ['Table', 'Form', 'Tree', 'Icon', 'Editor']

              for (const moduleName of exposedModules) {
                try {
                  addLog(`   å°è¯•åŠ è½½: ${moduleName}...`, 'info')
                  const module = await window.__FEDERATION__.robotAdmin.get(
                    `./${moduleName}`
                  )
                  if (module) {
                    addLog(`   âœ… ${moduleName} åŠ è½½æˆåŠŸ`, 'success')
                  } else {
                    addLog(`   âŒ ${moduleName} è¿”å›ç©º`, 'error')
                  }
                } catch (error) {
                  addLog(
                    `   âŒ ${moduleName} åŠ è½½å¤±è´¥: ${error.message}`,
                    'error'
                  )
                }
              }

              addLog('\nğŸ‰ æµ‹è¯•å®Œæˆï¼', 'success')
            } else {
              addLog('âŒ robotAdmin è¿œç¨‹æ¨¡å—æœªæ‰¾åˆ°', 'error')
            }
          } else {
            addLog('âŒ __FEDERATION__ å¯¹è±¡ä¸å­˜åœ¨', 'error')
            addLog('   è¿™æ„å‘³ç€ remoteEntry.js æ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–è”é‚¦é…ç½®', 'error')
          }
        } catch (error) {
          addLog(`\nâŒ æµ‹è¯•è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error')
          console.error('è¯¦ç»†é”™è¯¯:', error)
        }
      }
    </script>
  </body>
</html>
