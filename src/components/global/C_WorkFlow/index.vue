<!--
 * @Author: ChenYu ycyplus@gmail.com
 * @Date: 2025-07-03 09:13:12
 * @LastEditors: ChenYu ycyplus@gmail.com
 * @LastEditTime: 2025-07-03 13:44:16
 * @FilePath: \Robot_Admin\src\components\global\C_WorkFlow\index.vue
 * @Description: Â∑•‰ΩúÔºàÂÆ°ÊâπÊµÅÔºâÊµÅÁªÑ‰ª∂
 * Copyright (c) 2025 by CHENY, All Rights Reserved üòé. 
-->

<template>
  <div class="approval-workflow-container">
    <!-- ÊµÆÂä®Â∑•ÂÖ∑Ê†è -->
    <div class="floating-toolbar">
      <NButton
        size="small"
        type="primary"
        @click="saveWorkflow"
      >
        <template #icon
          ><div class="i-mdi:content-save w-4 h-4"></div
        ></template>
        ‰øùÂ≠ò
      </NButton>
      <NButton
        size="small"
        @click="previewWorkflow"
      >
        <template #icon><div class="i-mdi:eye w-4 h-4"></div></template>
        È¢ÑËßà
      </NButton>
      <NButton
        size="small"
        @click="validateCurrentWorkflow"
        title="Ê£ÄÊü•Â∑•‰ΩúÊµÅÈÖçÁΩÆÊòØÂê¶Ê≠£Á°Æ"
      >
        <template #icon
          ><div class="i-mdi:check-circle w-4 h-4"></div
        ></template>
        È™åËØÅÊµÅÁ®ã
      </NButton>

      <div class="toolbar-divider"></div>

      <NButton
        size="small"
        @click="fitView"
        title="ÈÄÇÂ∫îÁ™óÂè£"
      >
        <template #icon
          ><div class="i-mdi:fit-to-screen w-4 h-4"></div
        ></template>
      </NButton>
      <NButton
        size="small"
        type="error"
        @click="clearWorkflow"
        title="Ê∏ÖÁ©∫ÁîªÂ∏É"
      >
        <template #icon
          ><div class="i-mdi:delete-sweep w-4 h-4"></div
        ></template>
      </NButton>
    </div>

    <!-- Vue Flow ÁîªÂ∏É -->
    <VueFlow
      ref="vueFlowRef"
      v-model:nodes="nodes"
      v-model:edges="edges"
      :node-types="nodeTypes"
      class="workflow-canvas"
      :default-viewport="{ zoom: 1, x: 0, y: 0 }"
      :min-zoom="0.5"
      :max-zoom="2"
      :fit-view-on-init="true"
      :nodes-draggable="true"
      :elements-selectable="true"
      @node-click="onNodeClick"
      @pane-click="closeAddMenu"
    />

    <!-- ËäÇÁÇπÊ∑ªÂä†ËèúÂçï -->
    <Teleport to="body">
      <div
        v-show="showAddMenu"
        class="add-node-menu"
        :style="{ left: menuPosition.x + 'px', top: menuPosition.y + 'px' }"
      >
        <div class="add-menu-content">
          <div
            v-for="nodeType in NODE_TYPE_OPTIONS"
            :key="nodeType.type"
            class="add-menu-item"
            @click="addNode(nodeType.type)"
          >
            <div
              class="menu-icon"
              :class="nodeType.iconClass"
            >
              <div :class="nodeType.icon"></div>
            </div>
            <span class="menu-text">{{ nodeType.label }}</span>
          </div>
        </div>
      </div>
    </Teleport>

    <!-- ËäÇÁÇπÈÖçÁΩÆÂºπÁ™ó -->
    <NModal
      v-model:show="showNodeConfig"
      style="width: 900px"
      :mask-closable="false"
      preset="dialog"
      :title="configTitle"
      positive-text="Á°ÆÂÆö"
      negative-text="ÂèñÊ∂à"
      :loading="configLoading"
      @positive-click="saveNodeConfig"
      @negative-click="showNodeConfig = false"
    >
      <!-- ÂÆ°Êâπ‰∫∫ÈÖçÁΩÆ -->
      <div
        v-if="currentNode?.type === 'approval'"
        class="config-content"
      >
        <div class="config-section">
          <h4 class="section-title">
            <div class="i-mdi:account-check w-4 h-4"></div>
            ÈÄâÊã©ÂÆ°Êâπ‰∫∫
          </h4>

          <NInput
            v-model:value="searchKeyword"
            placeholder="ÊêúÁ¥¢Áî®Êà∑ÂßìÂêçÊàñÈÉ®Èó®"
            clearable
            class="search-input"
          >
            <template #prefix
              ><div class="i-mdi:magnify w-4 h-4"></div
            ></template>
          </NInput>

          <div class="user-tree-container">
            <NTree
              :data="departmentUserTree"
              :checked-keys="selectedUsers"
              :selectable="false"
              checkable
              cascade
              :virtual-scroll="true"
              style="max-height: 300px"
              @update:checked-keys="handleUserSelect"
            />
          </div>

          <div
            v-if="selectedApprovers.length > 0"
            class="selected-users"
          >
            <h5>Â∑≤ÈÄâÊã©ÂÆ°Êâπ‰∫∫ ({{ selectedApprovers.length }})</h5>
            <div class="selected-user-tags">
              <NTag
                v-for="user in selectedApprovers"
                :key="user.id"
                closable
                type="info"
                @close="removeApprover(user.id)"
              >
                <div class="user-tag-content">
                  <NAvatar
                    :src="user.avatar"
                    :fallback-src="getDefaultAvatar(user.name)"
                    size="small"
                  />
                  <span class="user-name">{{ user.name }}</span>
                  <span class="user-dept">{{ user.department }}</span>
                </div>
              </NTag>
            </div>
          </div>

          <div class="approval-mode-section">
            <h5>ÂÆ°ÊâπÊ®°Âºè</h5>
            <NRadioGroup v-model:value="approvalMode">
              <NSpace vertical>
                <NRadio
                  v-for="mode in APPROVAL_MODES"
                  :key="mode.value"
                  :value="mode.value"
                >
                  <div class="mode-option">
                    <strong>{{ mode.label }}</strong>
                    <span class="mode-desc">{{ mode.desc }}</span>
                  </div>
                </NRadio>
              </NSpace>
            </NRadioGroup>
          </div>
        </div>
      </div>

      <!-- ÊäÑÈÄÅ‰∫∫ÈÖçÁΩÆ -->
      <div
        v-else-if="currentNode?.type === 'copy'"
        class="config-content"
      >
        <div class="config-section">
          <h4 class="section-title">
            <div class="i-mdi:email-outline w-4 h-4"></div>
            ÈÄâÊã©ÊäÑÈÄÅ‰∫∫
          </h4>

          <NInput
            v-model:value="searchKeyword"
            placeholder="ÊêúÁ¥¢Áî®Êà∑ÂßìÂêçÊàñÈÉ®Èó®"
            clearable
            class="search-input"
          >
            <template #prefix
              ><div class="i-mdi:magnify w-4 h-4"></div
            ></template>
          </NInput>

          <div class="user-tree-container">
            <NTree
              :data="departmentUserTree"
              :checked-keys="selectedCopyUsers"
              :selectable="false"
              checkable
              cascade
              :virtual-scroll="true"
              style="max-height: 300px"
              @update:checked-keys="handleCopyUserSelect"
            />
          </div>

          <div
            v-if="selectedCopyUserList.length > 0"
            class="selected-users"
          >
            <h5>Â∑≤ÈÄâÊã©ÊäÑÈÄÅ‰∫∫ ({{ selectedCopyUserList.length }})</h5>
            <div class="selected-user-tags">
              <NTag
                v-for="user in selectedCopyUserList"
                :key="user.id"
                closable
                type="success"
                @close="removeCopyUser(user.id)"
              >
                <div class="user-tag-content">
                  <NAvatar
                    :src="user.avatar"
                    :fallback-src="getDefaultAvatar(user.name)"
                    size="small"
                  />
                  <span class="user-name">{{ user.name }}</span>
                  <span class="user-dept">{{ user.department }}</span>
                </div>
              </NTag>
            </div>
          </div>
        </div>
      </div>

      <!-- Êù°‰ª∂ÈÖçÁΩÆ -->
      <div
        v-else-if="currentNode?.type === 'condition'"
        class="config-content"
      >
        <div class="config-section">
          <h4 class="section-title">
            <div class="i-mdi:source-branch w-4 h-4"></div>
            Êù°‰ª∂ÂàÜÊîØËÆæÁΩÆ
          </h4>

          <div class="condition-builder">
            <div
              v-for="(condition, index) in conditions"
              :key="condition.id"
              class="condition-item"
            >
              <NCard
                size="small"
                class="condition-card"
              >
                <div class="condition-content">
                  <NInput
                    v-model:value="condition.name"
                    placeholder="ÂàÜÊîØÂêçÁß∞"
                    style="width: 150px"
                  />
                  <NSelect
                    v-model:value="condition.field"
                    placeholder="ÈÄâÊã©Â≠óÊÆµ"
                    :options="FIELD_OPTIONS"
                    style="width: 120px"
                  />
                  <NSelect
                    v-model:value="condition.operator"
                    placeholder="Êìç‰ΩúÁ¨¶"
                    :options="OPERATOR_OPTIONS"
                    style="width: 100px"
                  />
                  <NInput
                    v-model:value="condition.value"
                    placeholder="ÂÄº"
                    style="width: 120px"
                  />
                  <NButton
                    quaternary
                    type="error"
                    @click="removeCondition(index)"
                  >
                    <template #icon
                      ><div class="i-mdi:delete w-4 h-4"></div
                    ></template>
                  </NButton>
                </div>
              </NCard>
            </div>

            <NButton
              dashed
              block
              @click="addCondition"
            >
              <template #icon><div class="i-mdi:plus w-4 h-4"></div></template>
              Ê∑ªÂä†Êù°‰ª∂
            </NButton>
          </div>
        </div>
      </div>
    </NModal>

    <!-- È™åËØÅÈîôËØØÊó•ÂøóÊäΩÂ±â -->
    <NDrawer
      v-model:show="showValidationErrors"
      :width="450"
      placement="right"
    >
      <NDrawerContent
        title="ÊµÅÁ®ãÈ™åËØÅÁªìÊûú"
        closable
      >
        <div
          v-if="validationErrors.length === 0"
          class="validation-success"
        >
          <div class="success-icon">
            <div class="i-mdi:check-circle text-32px text-green-500"></div>
          </div>
          <h3>‚úÖ È™åËØÅÈÄöËøá</h3>
          <p>Â∑•‰ΩúÊµÅÈÖçÁΩÆÊ≠£Á°ÆÔºåÊâÄÊúâËäÇÁÇπÈÉΩÂ∑≤Ê≠£Á°ÆËÆæÁΩÆÔºÅ</p>
        </div>

        <div
          v-else
          class="validation-errors"
        >
          <div class="error-summary">
            <div class="error-icon">
              <div class="i-mdi:alert-circle text-24px text-red-500"></div>
            </div>
            <h3>‚ùå ÂèëÁé∞ {{ validationErrors.length }} ‰∏™ÈóÆÈ¢ò</h3>
            <p>ËØ∑‰øÆÂ§ç‰ª•‰∏ãÈóÆÈ¢òÂêéÈáçÊñ∞È™åËØÅÔºö</p>
          </div>

          <div class="error-list">
            <div
              v-for="(error, index) in validationErrors"
              :key="error.nodeId"
              class="error-item"
            >
              <div class="error-header">
                <span class="error-number">{{ index + 1 }}</span>
                <div class="error-info">
                  <strong class="error-node">{{ error.nodeName }}</strong>
                  <span class="error-field">{{
                    getFieldDisplayName(error.field)
                  }}</span>
                </div>
                <div
                  class="error-type"
                  :class="error.type"
                  >{{ getErrorTypeText(error.type) }}</div
                >
              </div>
              <div class="error-message">{{ error.message }}</div>
              <div class="error-actions">
                <NButton
                  size="small"
                  type="primary"
                  @click="jumpToErrorNode(error.nodeId)"
                >
                  <template #icon
                    ><div class="i-mdi:target w-4 h-4"></div
                  ></template>
                  ÂÆö‰ΩçËäÇÁÇπ
                </NButton>
              </div>
            </div>
          </div>

          <div class="validation-tips">
            <h4>üí° Â∏∏ËßÅÈóÆÈ¢òËß£ÂÜ≥ÊñπÊ°àÔºö</h4>
            <ul>
              <li
                ><strong>ÂÆ°Êâπ‰∫∫Êú™ËÆæÁΩÆÔºö</strong>
                ÁÇπÂáªÂÆ°ÊâπËäÇÁÇπÔºåÂú®ÂºπÁ™ó‰∏≠ÈÄâÊã©ÂÆ°Êâπ‰∫∫Âëò</li
              >
              <li
                ><strong>Êù°‰ª∂ÂàÜÊîØÊú™ÈÖçÁΩÆÔºö</strong>
                ÁÇπÂáªÊù°‰ª∂ËäÇÁÇπÔºåÊ∑ªÂä†Ëá≥Â∞ë‰∏Ä‰∏™Êù°‰ª∂ÂàÜÊîØ</li
              >
              <li
                ><strong>ËäÇÁÇπËøûÊé•Êñ≠ÂºÄÔºö</strong> Ê£ÄÊü•ËäÇÁÇπ‰πãÈó¥ÁöÑËøûÁ∫øÊòØÂê¶Ê≠£Á°Æ</li
              >
            </ul>
          </div>
        </div>

        <template #footer>
          <div class="validation-footer">
            <NButton @click="showValidationErrors = false">ÂÖ≥Èó≠</NButton>
            <NButton
              type="primary"
              @click="validateCurrentWorkflow"
            >
              <template #icon
                ><div class="i-mdi:refresh w-4 h-4"></div
              ></template>
              ÈáçÊñ∞È™åËØÅ
            </NButton>
          </div>
        </template>
      </NDrawerContent>
    </NDrawer>
  </div>
</template>

<script setup lang="ts">
  import { VueFlow, type NodeMouseEvent } from '@vue-flow/core'
  import type { Component } from 'vue'

  // ÂØºÂÖ•Á±ªÂûãÂÆö‰πâ
  import type {
    WorkflowNode,
    WorkflowEdge,
    WorkflowData,
    WorkflowProps,
    WorkflowEmits,
    NodeType,
    MenuPosition,
    User,
    ValidationError,
    Condition,
  } from '@/types/work-flow'

  // ÂØºÂÖ•Êï∞ÊçÆÂ∏∏Èáè
  import {
    NODE_TYPE_OPTIONS,
    APPROVAL_MODES,
    FIELD_OPTIONS,
    OPERATOR_OPTIONS,
    NODE_TITLES,
    CONFIG_TITLES,
    FIELD_DISPLAY_NAMES,
    ERROR_TYPE_TEXTS,
    INITIAL_NODE,
    getDefaultAvatar,
    createDefaultCondition,
    generateEdgeId,
  } from './data'

  // ÂØºÂÖ•ËäÇÁÇπÁªÑ‰ª∂
  import StartNode from './nodes/StartNode.vue'
  import ApprovalNode from './nodes/ApprovalNode.vue'
  import CopyNode from './nodes/CopyNode.vue'
  import ConditionNode from './nodes/ConditionNode.vue'

  // ËäÇÁÇπÁªÑ‰ª∂Êò†Â∞Ñ
  const NODE_TYPES: Record<string, Component> = {
    start: markRaw(StartNode),
    approval: markRaw(ApprovalNode),
    copy: markRaw(CopyNode),
    condition: markRaw(ConditionNode),
  }

  // Props & Emits
  const props = withDefaults(defineProps<WorkflowProps>(), {
    users: () => [],
    roles: () => [],
    departments: () => [],
    readonly: false,
    theme: 'light',
  })

  const emit = defineEmits<WorkflowEmits>()

  // ÂìçÂ∫îÂºèÊï∞ÊçÆ
  const message = useMessage()
  const vueFlowRef = ref()

  const nodes = ref<WorkflowNode[]>([{ ...INITIAL_NODE }])
  const edges = ref<WorkflowEdge[]>([])
  const showAddMenu = ref(false)
  const menuPosition = ref<MenuPosition>({ x: 0, y: 0 })
  const showNodeConfig = ref(false)
  const currentNode = ref<WorkflowNode | null>(null)
  const selectedUsers = ref<string[]>([])
  const selectedCopyUsers = ref<string[]>([])
  const searchKeyword = ref('')
  const approvalMode = ref<'any' | 'all' | 'sequence'>('any')
  const configLoading = ref(false)
  const conditions = ref<Condition[]>([])
  const validationErrors = ref<ValidationError[]>([])
  const showValidationErrors = ref(false)

  // ËÆ°ÁÆóÂ±ûÊÄß
  const nodeTypes = computed(() => NODE_TYPES)

  const configTitle = computed(() => {
    const type = currentNode.value?.type as keyof typeof CONFIG_TITLES
    return CONFIG_TITLES[type] || 'ËäÇÁÇπËÆæÁΩÆ'
  })

  const departmentUserTree = computed(() => {
    const tree: any[] = []
    const deptMap = new Map()

    // ÂàõÂª∫ÈÉ®Èó®ËäÇÁÇπ
    props.departments?.forEach(dept => {
      if (!deptMap.has(dept.id)) {
        deptMap.set(dept.id, {
          key: `dept-${dept.id}`,
          label: `${dept.name} ${dept.manager ? `(Ë¥üË¥£‰∫∫: ${dept.manager})` : ''}`,
          children: [],
          isLeaf: false,
          disabled: true,
        })
      }
    })

    // Ê∑ªÂä†Áî®Êà∑Âà∞ÂØπÂ∫îÈÉ®Èó®
    const filteredUsers =
      props.users?.filter(
        user =>
          !searchKeyword.value ||
          user.name.includes(searchKeyword.value) ||
          user.department.includes(searchKeyword.value)
      ) || []

    filteredUsers.forEach(user => {
      const dept = props.departments?.find(d => d.name === user.department)
      if (dept && deptMap.has(dept.id)) {
        deptMap.get(dept.id).children.push({
          key: user.id,
          label: `${user.name} (${user.role})`,
          isLeaf: true,
          user,
        })
      }
    })

    deptMap.forEach(dept => {
      if (dept.children.length > 0) {
        tree.push(dept)
      }
    })

    return tree
  })

  const selectedApprovers = computed(
    () => props.users?.filter(u => selectedUsers.value.includes(u.id)) || []
  )

  const selectedCopyUserList = computed(
    () => props.users?.filter(u => selectedCopyUsers.value.includes(u.id)) || []
  )

  const workflowStats = computed(() => {
    const totalNodes = nodes.value.length
    const approvalNodes = nodes.value.filter(n => n.type === 'approval').length
    const copyNodes = nodes.value.filter(n => n.type === 'copy').length
    const conditionNodes = nodes.value.filter(
      n => n.type === 'condition'
    ).length

    return { totalNodes, approvalNodes, copyNodes, conditionNodes }
  })

  // ÊñπÊ≥ï
  const handleShowAddMenu = (position: MenuPosition): void => {
    try {
      const x = typeof position.x === 'number' ? position.x : 0
      const y = typeof position.y === 'number' ? position.y : 0
      menuPosition.value = { x, y }
      showAddMenu.value = true
    } catch (error) {
      console.error('Error showing add menu:', error)
    }
  }

  provide('showAddMenu', handleShowAddMenu)

  const handleUserSelect = (keys: string[]) => {
    selectedUsers.value = keys.filter(key => !key.startsWith('dept-'))
  }

  const handleCopyUserSelect = (keys: string[]) => {
    selectedCopyUsers.value = keys.filter(key => !key.startsWith('dept-'))
  }

  const removeApprover = (userId: string) => {
    selectedUsers.value = selectedUsers.value.filter(id => id !== userId)
  }

  const removeCopyUser = (userId: string) => {
    selectedCopyUsers.value = selectedCopyUsers.value.filter(
      id => id !== userId
    )
  }

  const addCondition = () => {
    conditions.value.push(createDefaultCondition())
  }

  const removeCondition = (index: number) => {
    conditions.value.splice(index, 1)
  }

  const addNode = (type: NodeType): void => {
    try {
      const lastNode = nodes.value[nodes.value.length - 1]
      const newX = lastNode ? lastNode.position.x : 150
      const newY = lastNode ? lastNode.position.y + 120 : 250

      const newNode: WorkflowNode = {
        id: `${type}-${Date.now()}`,
        type,
        position: { x: newX, y: newY },
        data: {
          title: NODE_TITLES[type],
          status: 'pending',
          ...(type === 'approval' && { approvers: [], approvalMode: 'any' }),
          ...(type === 'copy' && { copyUsers: [] }),
          ...(type === 'condition' && { conditions: [] }),
        },
      }

      nodes.value.push(newNode)

      if (nodes.value.length > 1) {
        const lastNode = nodes.value[nodes.value.length - 2]
        const newEdge: WorkflowEdge = {
          id: generateEdgeId(lastNode.id, newNode.id),
          source: lastNode.id,
          target: newNode.id,
          animated: true,
          type: 'default',
        }
        edges.value.push(newEdge)
      }

      showAddMenu.value = false
      emitChange()

      nextTick(() => {
        setTimeout(() => {
          vueFlowRef.value?.fitView?.({ padding: 60, duration: 400 })
        }, 100)
      })
    } catch (error) {
      console.error('Error adding node:', error)
      message?.error?.('Ê∑ªÂä†ËäÇÁÇπÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')
    }
  }

  const onNodeClick = (event: NodeMouseEvent): void => {
    try {
      const node = event.node as WorkflowNode
      if (node.type !== 'start') {
        currentNode.value = node
        searchKeyword.value = ''

        if (node.type === 'approval') {
          const approvers = (node.data as any).approvers || []
          selectedUsers.value = approvers.map((u: User) => u.id)
          approvalMode.value = (node.data as any).approvalMode || 'any'
        } else if (node.type === 'copy') {
          const copyUsers = (node.data as any).copyUsers || []
          selectedCopyUsers.value = copyUsers.map((u: User) => u.id)
        } else if (node.type === 'condition') {
          conditions.value = (node.data as any).conditions || []
        }

        showNodeConfig.value = true
        emit('node-click', node)
      }
    } catch (error) {
      console.error('Error handling node click:', error)
    }
  }

  const closeAddMenu = (): void => {
    showAddMenu.value = false
  }

  const saveNodeConfig = async (): Promise<boolean> => {
    if (!currentNode.value) return false

    configLoading.value = true

    try {
      if (currentNode.value.type === 'approval') {
        if (selectedUsers.value.length === 0) {
          message.error('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÂÆ°Êâπ‰∫∫')
          return false
        }

        const selectedUserObjs = selectedApprovers.value
        ;(currentNode.value.data as any).approvers = selectedUserObjs
        ;(currentNode.value.data as any).approvalMode = approvalMode.value
        message.success(`Â∑≤ËÆæÁΩÆ ${selectedUserObjs.length} ‰∏™ÂÆ°Êâπ‰∫∫`)
      } else if (currentNode.value.type === 'copy') {
        const selectedUserObjs = selectedCopyUserList.value
        ;(currentNode.value.data as any).copyUsers = selectedUserObjs
        message.success(`Â∑≤ËÆæÁΩÆ ${selectedUserObjs.length} ‰∏™ÊäÑÈÄÅ‰∫∫`)
      } else if (currentNode.value.type === 'condition') {
        if (conditions.value.length === 0) {
          message.error('ËØ∑Ëá≥Â∞ëÊ∑ªÂä†‰∏Ä‰∏™Êù°‰ª∂ÂàÜÊîØ')
          return false
        }

        const validConditions = conditions.value.filter(
          c => c.name && c.field && c.operator && c.value
        )
        if (validConditions.length === 0) {
          message.error('ËØ∑ÂÆåÂñÑÊù°‰ª∂ÈÖçÁΩÆ')
          return false
        }

        ;(currentNode.value.data as any).conditions = validConditions
        message.success(`Â∑≤ËÆæÁΩÆ ${validConditions.length} ‰∏™Êù°‰ª∂ÂàÜÊîØ`)
      }

      showNodeConfig.value = false
      emitChange()
      return true
    } catch (error) {
      message.error('‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•')
      console.error('Save node config error:', error)
      return false
    } finally {
      configLoading.value = false
    }
  }

  const saveWorkflow = (): void => {
    const errors = validateWorkflow()
    if (errors.length > 0) {
      message?.error?.(`Â∑•‰ΩúÊµÅÈ™åËØÅÂ§±Ë¥•: ${errors[0].message}`)
      showValidationErrors.value = true
      return
    }

    const data = getCurrentWorkflowData()
    emit('save', data)
    message?.success?.('Â∑•‰ΩúÊµÅ‰øùÂ≠òÊàêÂäü')
  }

  const previewWorkflow = (): void => {
    const data = getCurrentWorkflowData()
    console.log('È¢ÑËßàÂ∑•‰ΩúÊµÅ', data)
    message?.info?.('È¢ÑËßàÂäüËÉΩÂºÄÂèë‰∏≠...')
  }

  const validateCurrentWorkflow = (): void => {
    const errors = validateWorkflow()
    validationErrors.value = errors

    if (errors.length === 0) {
      message?.success?.('‚úÖ Â∑•‰ΩúÊµÅÈ™åËØÅÈÄöËøáÔºÅÊâÄÊúâËäÇÁÇπÈÖçÁΩÆÊ≠£Á°Æ')
      showValidationErrors.value = false
    } else {
      message?.error?.(`‚ùå ÂèëÁé∞ ${errors.length} ‰∏™ÈóÆÈ¢òÔºåËØ∑Êü•ÁúãËØ¶ÁªÜÈîôËØØ`)
      showValidationErrors.value = true
      emit('validate-error', errors)
    }
  }

  const fitView = (): void => {
    try {
      if (vueFlowRef.value?.fitView) {
        nextTick(() => {
          vueFlowRef.value.fitView({
            padding: 50,
            includeHiddenNodes: false,
            minZoom: 0.5,
            maxZoom: 1.5,
            duration: 800,
          })
        })
        message?.success?.('Â∑≤ÈÄÇÂ∫îÁ™óÂè£Â§ßÂ∞è')
      } else {
        console.warn('VueFlow instance not ready')
        message?.warning?.('ÁîªÂ∏ÉÊú™ÂáÜÂ§áÂ∞±Áª™ÔºåËØ∑Á®çÂêéÈáçËØï')
      }
    } catch (error) {
      console.error('FitView error:', error)
      message?.error?.('ÈÄÇÂ∫îÁ™óÂè£Â§±Ë¥•')
    }
  }

  const clearWorkflow = (): void => {
    nodes.value = [{ ...INITIAL_NODE }]
    edges.value = []
    validationErrors.value = []
    showValidationErrors.value = false
    emitChange()

    nextTick(() => {
      setTimeout(() => {
        vueFlowRef.value?.fitView?.({ padding: 80, duration: 600 })
      }, 100)
    })

    message?.success?.('ÁîªÂ∏ÉÂ∑≤Ê∏ÖÁ©∫')
  }

  const validateWorkflow = (): ValidationError[] => {
    const errors: ValidationError[] = []

    nodes.value.forEach(node => {
      if (node.type === 'approval') {
        const approvers = (node.data as any).approvers || []
        if (approvers.length === 0) {
          errors.push({
            nodeId: node.id,
            nodeName: node.data.title,
            field: 'approvers',
            message: 'ÂÆ°ÊâπËäÇÁÇπÂøÖÈ°ªËÆæÁΩÆËá≥Â∞ë‰∏Ä‰∏™ÂÆ°Êâπ‰∫∫ÔºåÂê¶ÂàôÊµÅÁ®ãÊó†Ê≥ïÊ≠£Â∏∏ËøêË°å',
            type: 'required',
          })
        }
      }

      if (node.type === 'condition') {
        const conditions = (node.data as any).conditions || []
        if (conditions.length === 0) {
          errors.push({
            nodeId: node.id,
            nodeName: node.data.title,
            field: 'conditions',
            message:
              'Êù°‰ª∂ÂàÜÊîØËäÇÁÇπÂøÖÈ°ªÈÖçÁΩÆËá≥Â∞ë‰∏Ä‰∏™ÂàÜÊîØÊù°‰ª∂ÔºåÂê¶ÂàôÊó†Ê≥ïËøõË°åÊù°‰ª∂Âà§Êñ≠',
            type: 'required',
          })
        } else {
          const incompleteConditions = conditions.filter(
            (c: any) => !c.name || !c.field || !c.operator || !c.value
          )
          if (incompleteConditions.length > 0) {
            errors.push({
              nodeId: node.id,
              nodeName: node.data.title,
              field: 'conditions',
              message: `Êúâ ${incompleteConditions.length} ‰∏™Êù°‰ª∂ÂàÜÊîØÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåËØ∑ÂÆåÂñÑÊâÄÊúâÂøÖÂ°´Â≠óÊÆµ`,
              type: 'incomplete',
            })
          }
        }
      }
    })

    // Ê£ÄÊü•ËäÇÁÇπËøûÊé•
    const connectedNodes = new Set<string>()
    edges.value.forEach(edge => {
      connectedNodes.add(edge.source)
      connectedNodes.add(edge.target)
    })

    nodes.value.forEach(node => {
      if (node.type !== 'start' && !connectedNodes.has(node.id)) {
        errors.push({
          nodeId: node.id,
          nodeName: node.data.title,
          field: 'connection',
          message: 'Ê≠§ËäÇÁÇπÊú™‰∏éÂÖ∂‰ªñËäÇÁÇπËøûÊé•ÔºåÂèØËÉΩÂØºËá¥ÊµÅÁ®ã‰∏≠Êñ≠',
          type: 'warning',
        })
      }
    })

    return errors
  }

  const getFieldDisplayName = (field: string): string =>
    FIELD_DISPLAY_NAMES[field] || field
  const getErrorTypeText = (type: string): string =>
    ERROR_TYPE_TEXTS[type] || type

  const jumpToErrorNode = (nodeId: string): void => {
    const node = nodes.value.find(n => n.id === nodeId)
    if (node && vueFlowRef.value) {
      vueFlowRef.value.setCenter(node.position.x, node.position.y, {
        zoom: 1.2,
        duration: 800,
      })

      setTimeout(() => {
        if (node.type !== 'start') {
          currentNode.value = node
          showNodeConfig.value = true
          showValidationErrors.value = false
        }
      }, 900)

      message?.info?.(`Â∑≤ÂÆö‰ΩçÂà∞ËäÇÁÇπÔºö${node.data.title}`)
    }
  }

  const getCurrentWorkflowData = (): WorkflowData => ({
    nodes: nodes.value,
    edges: edges.value,
    config: {
      version: '1.0',
      createdAt: new Date().toISOString(),
    },
  })

  const emitChange = (): void => {
    const data = getCurrentWorkflowData()
    emit('update:modelValue', data)
    emit('change', data)
  }

  // ÁõëÂê¨Âô®
  watch(
    () => props.modelValue,
    newValue => {
      if (newValue && newValue !== getCurrentWorkflowData()) {
        nodes.value = newValue.nodes || []
        edges.value = newValue.edges || []
      }
    },
    { deep: true }
  )

  onMounted(() => {
    nextTick(() => {
      setTimeout(() => {
        vueFlowRef.value?.fitView?.({
          padding: 80,
          includeHiddenNodes: false,
          minZoom: 0.8,
          maxZoom: 1.2,
          duration: 600,
        })
      }, 300)
    })
  })

  defineExpose({
    validateWorkflow,
    getCurrentWorkflowData,
    saveWorkflow,
    previewWorkflow,
    stats: workflowStats,
  })
</script>

<style scoped lang="scss">
  @use './index.scss';
</style>
